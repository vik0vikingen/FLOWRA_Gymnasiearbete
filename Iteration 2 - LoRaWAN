//Denna kod används för att koppla CubeCell trådlöst till en gateway. Detta är i princip själva LoRaWAN-delen av mjukvaran.

#include "LoRaWan_APP.h"
#include "Arduino.h"

uint8_t devEui[] = { 0x00, 0x07, 0x2F, 0x30, 0x03, 0x3A, 0x75, 0x27 }; 
uint8_t appEui[] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }; 
uint8_t appKey[] = { 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x66, 0x01 };

uint8_t nwkSKey[] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
uint8_t appSKey[] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
uint32_t devAddr =  ( uint32_t )0x00000000;

uint16_t userChannelsMask[6]={ 0x00FF,0x0000,0x0000,0x0000,0x0000,0x0000 };
LoRaMacRegion_t loraWanRegion = ACTIVE_REGION;
DeviceClass_t  loraWanClass = LORAWAN_CLASS;
bool overTheAirActivation = LORAWAN_NETMODE;
bool loraWanAdr = LORAWAN_ADR;
bool keepNet = LORAWAN_NET_RESERVE;
bool isTxConfirmed = LORAWAN_UPLINKMODE;
uint8_t appPort = 2;
uint8_t confirmedNbTrials = 4;
uint32_t appTxDutyCycle = 30000; 

static void prepareTxFrame( uint8_t port )
{
    appDataSize = 16; 

    //Notera: Ej verklig data. Poängen är att vi ska kunna "joina" Pingday-systemet - vilket blir lättare ifall man inte alltid har sensorn igång. 
    //Strängen som skickas "decodas" på precis samma sätt som verklig sensordata, dvs alla bitar korresponderar på rätt ställe i bit-kartan.
    appData[0] = 0xFF; appData[1] = 0xDD; // Temp
    appData[2] = 0x01; appData[3] = 0x64; // fukt
    appData[4] = 0x03; appData[5] = 0xF0; // EC
    appData[6] = 0x02; appData[7] = 0xAE; // pH
    appData[8] = 0x00; appData[9] = 0x87; // N
    appData[10] = 0x00; appData[11] = 0x8A; // P
    appData[12] = 0x00; appData[13] = 0x8E; // K
    appData[14] = 0x01; appData[15] = 0xF4; //salt
    
    Serial.println("\n-------------------------------------------");
    Serial.println("Förbereder datapaket:");
    Serial.print("Innehåll: ");
    
    for(int i=0; i < appDataSize; i++) {
        Serial.print("0x");
        if(appData[i] < 0x10) Serial.print("0"); 
        Serial.print(appData[i], HEX);
        Serial.print(" ");
    }
    Serial.println("");
    Serial.print("Totala bytes: ");
    Serial.println(appDataSize);
    Serial.println("-------------------------------------------");
}

void setup() {
  Serial.begin(115200);
  #if(AT_SUPPORT)
  enableAt();
  #endif
  deviceState = DEVICE_STATE_INIT;
  LoRaWAN.ifskipjoin();
}

void loop()
{
  switch( deviceState )
  {
    case DEVICE_STATE_INIT:
    {
      #if(LORAWAN_DEVEUI_AUTO)
        LoRaWAN.generateDeveuiByChipID();
      #endif
      printDevParam();
      LoRaWAN.init(loraWanClass,loraWanRegion);
      deviceState = DEVICE_STATE_JOIN;
      break;
    }
    case DEVICE_STATE_JOIN:
    {
      LoRaWAN.join();
      break;
    }
    case DEVICE_STATE_SEND:
    {
      prepareTxFrame( appPort );
      LoRaWAN.send();
      deviceState = DEVICE_STATE_CYCLE;
      break;
    }
    case DEVICE_STATE_CYCLE:
    {
      txDutyCycleTime = appTxDutyCycle + randr( 0, APP_TX_DUTYCYCLE_RND );
      LoRaWAN.cycle(txDutyCycleTime);
      deviceState = DEVICE_STATE_SLEEP;
      break;
    }
    case DEVICE_STATE_SLEEP:
    {
      LoRaWAN.sleep();
      break;
    }
    default:
    {
      deviceState = DEVICE_STATE_INIT;
      break;
    }
  }
}
