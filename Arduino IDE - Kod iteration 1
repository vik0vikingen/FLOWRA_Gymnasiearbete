#include <ModbusMaster.h>

#define RS485_EN 3  

ModbusMaster sensor;

void preTransmission() {
  delayMicroseconds(50);
  digitalWrite(RS485_EN, HIGH);
}

void postTransmission() {
  delayMicroseconds(50);
  digitalWrite(RS485_EN, LOW);
}

void setup() {
  Serial.begin(115200);
  delay(5000);

  pinMode(RS485_EN, OUTPUT);
  digitalWrite(RS485_EN, LOW);


  Serial1.begin(9600, SERIAL_8N1);
  sensor.begin(1, Serial1);

  sensor.preTransmission(preTransmission);
  sensor.postTransmission(postTransmission);

  Serial.println("test start");
}

void loop() {
  Serial.println("alive");
  uint8_t result = sensor.readHoldingRegisters(0x0000, 8);
  Serial.print("resultat: ");
  Serial.println(result);
  if (result == sensor.ku8MBSuccess) {
    Serial.print("Temp: ");
    Serial.println(sensor.getResponseBuffer(0) / 10.0);

    Serial.print("Moisture: ");
    Serial.println(sensor.getResponseBuffer(1) / 10.0);

    Serial.print("EC: ");
    Serial.println(sensor.getResponseBuffer(2));

    Serial.print("pH: ");
    Serial.println(sensor.getResponseBuffer(3) / 100.0);

    Serial.print("N: ");
    Serial.println(sensor.getResponseBuffer(4));

    Serial.print("P: ");
    Serial.println(sensor.getResponseBuffer(5));

    Serial.print("K: ");
    Serial.println(sensor.getResponseBuffer(6));

    Serial.println("-----");
  } else {
    Serial.print("Fail error: ");
    Serial.println(result);
  }

  delay(3000);
}
